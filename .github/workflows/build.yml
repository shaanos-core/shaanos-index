name: Build ShaanOS Packages Github

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x86_64, x86]
      max-parallel: 1  # SÄ±rayla Ã§alÄ±ÅŸtÄ±r

    steps:
      - name: Checkout repository (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: true         # Submoduleâ€™leri de klonla
          fetch-depth: 0           # GeÃ§miÅŸi tam indir
          token: ${{ secrets.GH_TOKEN }}  # EÄŸer private repo ise PAT kullan

      - name: Show submodule status
        run: |
          echo "=== ðŸ§© Submodule bilgileri ==="
          git submodule status || echo "Submodule bilgisi alÄ±namadÄ±"
          echo "=== ðŸ“‚ Packages klasÃ¶rÃ¼ iÃ§eriÄŸi ==="
          ls -la packages || echo "âŒ packages klasÃ¶rÃ¼ bulunamadÄ±!"

      - name: Build packages for ${{ matrix.arch }}
        env:
          RSA_PRIVATE_KEY: ${{ secrets.RSA_PRIVATE_KEY }}
          RSA_PUBLIC_KEY: ${{ secrets.RSA_PUBLIC_KEY }}
          TARGET_ARCH: ${{ matrix.arch }}
        run: |
          if [ "${{ matrix.arch }}" = "x86" ]; then
            ALPINE_IMAGE="i386/alpine:edge"
          else
            ALPINE_IMAGE="alpine:edge"
          fi
          
          docker run --rm \
            -v "$GITHUB_WORKSPACE:/workspace" \
            -w /workspace \
            -e RSA_PRIVATE_KEY="$RSA_PRIVATE_KEY" \
            -e RSA_PUBLIC_KEY="$RSA_PUBLIC_KEY" \
            -e TARGET_ARCH="$TARGET_ARCH" \
            "$ALPINE_IMAGE" sh -c '
            set -e
            echo "=== ðŸ”§ Ortam hazÄ±rlanÄ±yor ($TARGET_ARCH) ==="
            apk add --no-cache alpine-sdk shadow sudo git

            adduser -D builder
            addgroup builder abuild
            echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

            mkdir -p /home/builder/.abuild
            echo "$RSA_PRIVATE_KEY" > /home/builder/.abuild/shaanos-key.rsa
            echo "$RSA_PUBLIC_KEY" > /home/builder/.abuild/shaanos-key.rsa.pub
            cp /home/builder/.abuild/shaanos-key.rsa.pub /etc/apk/keys/
            chown -R builder:builder /home/builder/.abuild
            chmod 600 /home/builder/.abuild/shaanos-key.rsa

            echo "PACKAGER=\"Åžahan YÄ±lmaz <sahanyilmaz1@outlook.com>\"" > /home/builder/.abuild/abuild.conf
            echo "PACKAGER_PRIVKEY=\"/home/builder/.abuild/shaanos-key.rsa\"" >> /home/builder/.abuild/abuild.conf
            echo "CARCH=\"$TARGET_ARCH\"" >> /home/builder/.abuild/abuild.conf

            if [ ! -d "/workspace/packages" ]; then
                echo "âŒ HATA: /workspace/packages dizini bulunamadÄ±!"
                ls -la /workspace/
                exit 1
            fi

            echo "ðŸ“‚ Packages dizini iÃ§eriÄŸi:"
            ls -la /workspace/packages/

            chown -R builder:builder /workspace/packages

            mkdir -p /workspace/public/core/$TARGET_ARCH
            rm -rf /workspace/public/core/$TARGET_ARCH/* || true

            echo "=== ðŸ“¦ ShaanOS paketleri derleniyor ($TARGET_ARCH) ==="
            cd /workspace/packages/ || exit 1

            SHAAN_PAKETLERI="shaan-baselayout shaan-base shaan-setup shaan-wbdev"
            ALPINE_PAKETLERI="alpine-keys openrc busybox alpine-conf apk-tools musl linux-pam"

            for paket in $SHAAN_PAKETLERI; do
                if [ -d "$paket" ]; then
                    echo ">>> $paket derleniyor..."
                    cd "$paket"
                    if sudo -u builder sh -c "CARCH=$TARGET_ARCH abuild checksum && CARCH=$TARGET_ARCH abuild -r"; then
                        echo "âœ… $paket baÅŸarÄ±yla derlendi"
                    else
                        echo "âš ï¸ $paket derleme baÅŸarÄ±sÄ±z!"
                    fi
                    cd ..
                else
                    echo "âš ï¸ $paket dizini yok, atlanÄ±yor."
                fi
            done

            for paket in $ALPINE_PAKETLERI; do
                if [ -d "$paket" ]; then
                    echo ">>> $paket derleniyor..."
                    cd "$paket"
                    if sudo -u builder sh -c "CARCH=$TARGET_ARCH abuild checksum && CARCH=$TARGET_ARCH abuild -r"; then
                        echo "âœ… $paket baÅŸarÄ±yla derlendi"
                    else
                        echo "âš ï¸ $paket derleme baÅŸarÄ±sÄ±z!"
                    fi
                    cd ..
                else
                    echo "âš ï¸ $paket dizini yok, atlanÄ±yor."
                fi
            done

            echo "=== ðŸ“ Derlenen dosyalar kopyalanÄ±yor ($TARGET_ARCH) ==="
            mkdir -p /workspace/public/core/$TARGET_ARCH

            APK_COUNT=0
            if [ -d "/home/builder/packages" ]; then
                for apk in $(find /home/builder/packages -name "*.apk"); do
                    cp -v "$apk" /workspace/public/core/$TARGET_ARCH/
                    APK_COUNT=$((APK_COUNT + 1))
                done
            fi

            find /home/builder/packages -name "APKINDEX.tar.gz" -exec cp -v {} /workspace/public/core/$TARGET_ARCH/ \; 2>/dev/null || true
            cp /home/builder/.abuild/shaanos-key.rsa.pub /workspace/public/core/ 2>/dev/null || true
            chown -R 1001:121 /workspace/public 2>/dev/null || chown -R $(stat -c %u /workspace):$(stat -c %g /workspace) /workspace/public

            echo "=== âœ… Derleme tamamlandÄ± ($TARGET_ARCH) ==="
            echo "ðŸ“Š Toplam $APK_COUNT paket derlendi"
            echo "ðŸ“‚ Public dizini iÃ§eriÄŸi:"
            ls -lh /workspace/public/core/$TARGET_ARCH/ || echo "âš ï¸ Dizin boÅŸ veya bulunamadÄ±"
          '

      - name: Fix permissions
        run: sudo chown -R $USER:$USER .

      - name: Commit and push packages
        run: |
          git config user.name "shaanvision"
          git config user.email "shaanvision@users.noreply.github.com"
          echo "=== ðŸ” Commit iÅŸlemi baÅŸlatÄ±lÄ±yor (${{ matrix.arch }}) ==="

          git add public/
          if git diff --staged --quiet; then
            echo "âš ï¸ DeÄŸiÅŸiklik yok, commit atlanÄ±yor"
            ls -la public/core/${{ matrix.arch }}/ 2>/dev/null || echo "Dizin bulunamadÄ±"
          else
            git fetch origin main
            git pull --rebase origin main || git pull origin main
            git add public/
            PACKAGE_COUNT=$(find public/core/${{ matrix.arch }} -name "*.apk" 2>/dev/null | wc -l)
            git commit -m "Rebuild ShaanOS packages (${{ matrix.arch }}): $PACKAGE_COUNT APK derlendi [$(date +'%Y-%m-%d %H:%M:%S')]"
            git push origin main
            echo "âœ… Paketler baÅŸarÄ±yla public/core/${{ matrix.arch }}/ dizinine yÃ¼klendi!"
          fi

